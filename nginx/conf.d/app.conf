# =============================================================================
# Upstream — Next.js app container
# =============================================================================
upstream nextjs_app {
    server app:3000;
    keepalive 32;
}


# =============================================================================
# HTTP — Redirect to HTTPS & serve ACME challenge for Let's Encrypt
# =============================================================================
server {
    listen      80;
    listen      [::]:80;
    server_name akbar-ahmadi.ir www.akbar-ahmadi.ir akbaramd.ir www.akbaramd.ir;

    # Health check endpoint for Docker (no redirect)
    location /healthz {
        access_log off;
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }

    # Let's Encrypt ACME HTTP-01 challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect everything else to HTTPS on the primary domain
    location / {
        return 301 https://akbar-ahmadi.ir$request_uri;
    }
}


# =============================================================================
# HTTPS — Primary domain: akbar-ahmadi.ir
# =============================================================================
server {
    listen      443 ssl http2;
    listen      [::]:443 ssl http2;
    server_name akbar-ahmadi.ir www.akbar-ahmadi.ir;

    # --- SSL certificates (managed by Certbot) ---
    ssl_certificate     /etc/letsencrypt/live/akbar-ahmadi.ir/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/akbar-ahmadi.ir/privkey.pem;

    # --- Recommended SSL settings (written by init-letsencrypt.sh) ---
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Redirect www → non-www (canonical)
    if ($host = www.akbar-ahmadi.ir) {
        return 301 https://akbar-ahmadi.ir$request_uri;
    }

    # --- Security headers ---
    add_header Strict-Transport-Security  "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Frame-Options            "SAMEORIGIN"  always;
    add_header X-Content-Type-Options     "nosniff"     always;
    add_header X-XSS-Protection           "1; mode=block" always;
    add_header Referrer-Policy            "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy         "camera=(), microphone=(), geolocation=()" always;

    # --- Next.js static assets — cache forever (immutable, content-hashed) ---
    location /_next/static/ {
        proxy_pass http://nextjs_app;
        add_header Cache-Control "public, max-age=31536000, immutable";
        access_log off;
    }

    # --- Public folder — 1 day cache ---
    location ~* ^/(?!_next).*\.(ico|png|jpg|jpeg|gif|svg|webp|woff|woff2|ttf|otf|eot|pdf)$ {
        proxy_pass http://nextjs_app;
        add_header Cache-Control "public, max-age=86400";
        access_log off;
    }

    # --- Next.js image optimization ---
    location /_next/image {
        proxy_pass http://nextjs_app;
        add_header Cache-Control "public, max-age=86400";
    }

    # --- Health check (no logging) ---
    location /healthz {
        proxy_pass http://nextjs_app;
        access_log off;
    }

    # --- All other requests → Next.js app ---
    location / {
        limit_req zone=api burst=50 nodelay;
        proxy_pass http://nextjs_app;
    }
}


# =============================================================================
# HTTPS — Secondary domain: akbaramd.ir → redirect to primary
# =============================================================================
server {
    listen      443 ssl http2;
    listen      [::]:443 ssl http2;
    server_name akbaramd.ir www.akbaramd.ir;

    ssl_certificate     /etc/letsencrypt/live/akbaramd.ir/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/akbaramd.ir/privkey.pem;

    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Redirect all traffic to the primary domain (301 = permanent)
    return 301 https://akbar-ahmadi.ir$request_uri;
}
